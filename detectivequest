#include <stdio.h>
#include <stdlib.h>
#include <time.h>

typedef struct Card {
    int value;
    struct Card *next;
} Card;

typedef struct Queue {
    Card *front, *rear;
    int size;
} Queue;

Queue* create_queue() {
    Queue *q = malloc(sizeof(Queue));
    q->front = q->rear = NULL;
    q->size = 0;
    return q;
}

void enqueue(Queue *q, int value) {
    Card *c = malloc(sizeof(Card));
    c->value = value;
    c->next = NULL;
    if (!q->rear) q->front = q->rear = c;
    else {
        q->rear->next = c;
        q->rear = c;
    }
    q->size++;
}

int dequeue(Queue *q) {
    if (!q->front) return -1;
    Card *t = q->front;
    int v = t->value;
    q->front = t->next;
    if (!q->front) q->rear = NULL;
    free(t);
    q->size--;
    return v;
}

int peek(Queue *q) {
    return q->front ? q->front->value : -1;
}

void free_queue(Queue *q) {
    while (q->front) dequeue(q);
    free(q);
}

void shuffle_deal(Queue *p1, Queue *p2) {
    int deck[52];
    int idx = 0;
    for (int suit = 0; suit < 4; suit++)
        for (int v = 2; v <= 14; v++)
            deck[idx++] = v;
    for (int i = 51; i > 0; i--) {
        int j = rand() % (i+1);
        int tmp = deck[i]; deck[i] = deck[j]; deck[j] = tmp;
    }
    for (int i = 0; i < 52; i++) {
        if (i % 2 == 0) enqueue(p1, deck[i]);
        else enqueue(p2, deck[i]);
    }
}

void collect_cards(Queue *winner, Card *pile_front) {
    Card *cur = pile_front;
    while (cur) {
        enqueue(winner, cur->value);
        cur = cur->next;
    }
}

int play_round(Queue *p1, Queue *p2) {
    if (p1->size == 0 || p2->size == 0) return 0;
    Card *pile = NULL, *pile_tail = NULL;
    auto push_pile = [&](int val){
        Card *n = malloc(sizeof(Card));
        n->value = val;
        n->next = NULL;
        if (!pile) pile = pile_tail = n;
        else { pile_tail->next = n; pile_tail = n; }
    };
    int a = dequeue(p1);
    int b = dequeue(p2);
    push_pile(a); push_pile(b);

    while (1) {
        if (a > b) { collect_cards(p1, pile); return 1; } 
        else if (b > a) { collect_cards(p2, pile); return 2; }
        printf("Empate! Guerra...\n");
        if (p1->size == 0 || p2->size == 0) {
            if (p1->size == 0) { collect_cards(p2, pile); return 2; }
            else { collect_cards(p1, pile); return 1; }
        }
        push_pile(dequeue(p1));
        push_pile(dequeue(p2));
        if (p1->size == 0 || p2->size == 0) {
            if (p1->size == 0) { collect_cards(p2, pile); return 2; }
            else { collect_cards(p1, pile); return 1; }
        }
        a = dequeue(p1);
        b = dequeue(p2);
        push_pile(a); push_pile(b);
    }
}

int main() {
    srand(time(NULL));
    Queue *p1 = create_queue();
    Queue *p2 = create_queue();
    shuffle_deal(p1, p2);
    printf("Iniciando War (simples)!\n");
    int rounds = 0;
    while (p1->size > 0 && p2->size > 0 && rounds < 10000) {
        rounds++;
        int winner = play_round(p1, p2);
        if (rounds % 50 == 0) {
            printf("Round %d: P1=%d cartas, P2=%d cartas\n", rounds, p1->size, p2->size);
        }
    }
    if (p1->size > p2->size) printf("Jogador 1 venceu em %d rounds! P1=%d P2=%d\n", rounds, p1->size, p2->size);
    else if (p2->size > p1->size) printf("Jogador 2 venceu em %d rounds! P1=%d P2=%d\n", rounds, p1->size, p2->size);
    else printf("Empate depois de %d rounds.\n", rounds);

    free_queue(p1);
    free_queue(p2);
    return 0;
}